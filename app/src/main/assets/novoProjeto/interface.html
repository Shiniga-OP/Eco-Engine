<!DOCTYPE html>
<html>
  <head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Eco-Engine - central</title>
	<script src="engine.js"></script>
	<script src="../.config/ace.min.js"></script>
	<script src="../.config/lang.min.js"></script>
	<script src="../.config/mode-javascript.min.js"></script>
	<script src="../.config/mode-html.min.js"></script>
	<script src="../.config/mode-css.min.js"></script>
	<script src="../.config/theme-monokai.min.js"></script>
<style>
html, body {
  margin:0;
  padding:0;
  height:100%;
  background:#111;
  color:#0f0;
  font-family:monospace;
  overflow:hidden;
}
#barraFerramentas, #pasta {
  border:1px solid #444;
  display:flex;
  padding:5px;
}
#barraFerramentas select, input, button {
  margin-right:5px;
  background:#111;
  border:1px solid #444;
  color:#0f0;
  padding:5px;
  cursor:pointer;
}
#pasta select, input, button {
  margin-right:5px;
  background:#111;
  border:1px solid #444;
  color:#0f0;
  padding:5px;
  cursor:pointer;
}
#icone {
    width: 50px;
    height: 50px;
    image-rendering: pixelated;
    image-rendering: crisp-edges;
}
#barraFerramentas input { width:100px; }
#conteudo {
  height:calc(100% - 42px);
  position:relative;
  background:#000;
}
.pagina {
  display:none;
  position:absolute;
  top:0;
  left:0;
  width:100%;
  height:100%;
}

.pagina.ativa { display:block; }
.escondido { display:none; }

#telaJogo {
  border: 1px solid #444;
  background: #000;
  display: block;
  margin: auto;
  position: absolute;
  top: 0; bottom: 0; left: 0; right: 0;
  image-rendering: pixelated;
  image-rendering: crisp-edges;
}

#editorCodigo {
  width:100%;
  height:100%;
}
#pagina {
  width:100%;
  height:100%;
  display:block;
}
#console {
    position:absolute;
    bottom:0;
    left:0;
    width:100%;
    height:100%;
    overflow:auto;
    background:#000;
    border-top:1px solid #444;
    color:#0f0;
    font-family:monospace;
    font-size:12px;
    white-space:pre-wrap;
}
</style>
  </head>
  <body>
	<div id="barraFerramentas">
	  <button onClick="voltarCasa()">Casa</button>
	  <select id="listaPaginas" onchange="trocarPagina(this.value)">
		<option value="jogo.html">Jogo</option>
		<option value="editor">Editor</option>
		<option value="arquivosDiv">Arquivos</option>
		<option value="console">Console</option>
		<option value="editorPixel.html">Estúdio pixel</option>
		<option value="editorMapas.html">Editor de mapas</option>
		<option value="editorMusica.html">Produtor de músicas</option>
		<option value="../doc.html">Documentação</option>
	  </select>
	  <button onclick="abrir()">Abrir</button>
	  <input id="nomeArquivo" type="text" placeholder="caminho do arquivo">
	  <button onclick="salvar()">Salvar</button>
	  <button onClick="executar()">Rodar</button>
	  <button onClick="abrirScripts()">HTML</button>
	  <button onclick="trocarPaginaB()"><</button>
	  <button onclick="trocarPaginaP()">></button>
	  <button onClick="location.reload()" id="reiniciar">Reiniciar</button>
	</div>
	<div id="conteudo">
	  <div id="paginaDiv" class="pagina">
		<iframe id="pagina"></iframe>
	  </div>
	  <div id="editor" class="pagina">
		<div id="editorCodigo"></div>
	  </div>
	  <div id="scriptsMenu" class="pagina">
	      <div>
	          <h3>Componentes do projeto:</h3>
	          <button id="sairScripts">X</button>
	      </div>
	      <div id="componentes"></div>
	  </div>
	  <div id="arquivosDiv" class="pagina">
		<div id="arquivos"></div>
	  </div>
	  <div id="console" class="pagina"></div>
	</div>
<!--
<script type="module">
    import "../.config/eruda.min.js";
    eruda.init();
</script> -->
<script>
let caminho = "";
let dev = false;

if(typeof Android !== "undefined" && Android !== null) dev = false;
else dev = true;

let modoDelete = false;
let inicio = `<script src="../.config/eruda.min.js"><\/script><script>eruda.init();<\/script>\n<canvas id="telaJogo"><\/canvas>\n<script>eval(Android.ler("nucleo.js")+\`\nconst eco = new Motor("telaJogo");\`);<\/script>\n<script>eval(Android.ler("scripts\/jogo.js"));<\/script>\n`;

if(!dev) {
    document.getElementById("reiniciar").classList.add("escondido");
}

if(!dev && (Android.ler("jogo.html")=="" || !Android.arquivoExiste("jogo.html"))) {
    Android.arquivar("jogo.html", inicio);
} else if(!dev) {
    inicio = Android.ler("jogo.html");
}
const antigoConsoleLog = console.log;
console.log = function() {
    antigoConsoleLog.apply(console, arguments);
    const msg = Array.from(arguments).map(arg => {
        if(arg instanceof Error) return `Erro: ${arg.message}\nStack: ${arg.stack}`;
        else if(typeof arg === 'object' && arg !== null) {
            try {
                return JSON.stringify(arg, null, 2);
            } catch(e) {
                return String(arg);
            }
        } else return String(arg);
    });
    const div = document.getElementById("console");
    if(div) {
        div.innerHTML += msg.join(' ') + '\n';
        div.scrollTop = div.scrollHeight;
    }
};
const antigoConsoleError = console.error;
console.error = function() {
    antigoConsoleError.apply(console, arguments);
    const msg = Array.from(arguments).map(arg => {
        if(arg instanceof Error) return `❌ ERRO: ${arg.message}\nStack: ${arg.stack}`;
        else if(typeof arg === 'object' && arg !== null) {
            try {
                return `❌ ${JSON.stringify(arg, null, 2)}`;
            } catch(e) {
                return `❌ ${String(arg)}`;
            }
        } else return `❌ ${String(arg)}`;
    });
    const div = document.getElementById("console");
    if(div) {
        div.innerHTML += msg.join(' ') + '\n';
        div.scrollTop = div.scrollHeight;
    }
};
const antigoConsoleWarn = console.warn;
console.warn = function() {
    antigoConsoleWarn.apply(console, arguments);
    const msg = Array.from(arguments).map(arg => {
        if(typeof arg === 'object' && arg !== null) {
            try {
                return `⚠️ ${JSON.stringify(arg, null, 2)}`;
            } catch(e) {
                return `⚠️ ${String(arg)}`;
            }
        } else return `⚠️ ${String(arg)}`;
    });
    const div = document.getElementById("console");
    if(div) {
        div.innerHTML += msg.join(' ') + '\n';
        div.scrollTop = div.scrollHeight;
    }
};
const editor = ace.edit("editorCodigo");
editor.setTheme("ace/theme/monokai");
editor.session.setMode("ace/mode/javascript");
editor.setOptions({
    enableBasicAutocompletion: true,
    enableLiveAutocompletion: true, // completa enquanto digita
    showLineNumbers: true, // mostra numeração de linha
    showGutter: true, // mostra a gutter(area dos números)
    highlightActiveLine: true, // destaca a linha atual
});
console.log("console...");

function trocarPagina(id) {
  const paginas = document.querySelectorAll(".pagina");
  for(let i = 0; i < paginas.length; i++) paginas[i].classList.remove("ativa");

  if(id.includes("/") || id.endsWith(".html")) {
    document.getElementById("paginaDiv").classList.add("ativa");
    document.getElementById("pagina").src = id;
  } else document.getElementById(id).classList.add("ativa");
}

function trocarPaginaB() {
  const lista = Array.from(document.getElementById("listaPaginas").options).map(opcao => opcao.value);
  const atual = document.getElementById("listaPaginas").value;
  let indice = lista.indexOf(atual);
  if(indice > 0) indice--;
  trocarPagina(lista[indice]);
  document.getElementById("listaPaginas").value = lista[indice];
}

function trocarPaginaP() {
  const lista = Array.from(document.getElementById("listaPaginas").options).map(opcao => opcao.value);
  const atual = document.getElementById("listaPaginas").value;
  let indice = lista.indexOf(atual);
  if(indice < lista.length - 1) indice++;
  trocarPagina(lista[indice]);
  document.getElementById("listaPaginas").value = lista[indice];
}

function salvar() {
  if(dev) return;
  const arq = document.getElementById("nomeArquivo").value.trim();
  Android.arquivar(arq, editor.getValue());
  Android.msg("Projeto salvo em: "+arq);
}

function abrir() {
  if(dev) return;
  const arq = document.getElementById("nomeArquivo").value.trim();
  if(arq.endsWith(".html")) editor.session.setMode("ace/mode/html");
  else if(arq.endsWith(".css")) editor.session.setMode("ace/mode/css");
  else if(arq.endsWith(".js")) editor.session.setMode("ace/mode/javascript");
  else editor.session.setMode("ace/mode/txt");
  editor.setValue(Android.ler(arq), -1);
  Android.msg("Arquivo aberto");
}

function executar() {
  console.clear();
  document.getElementById("console").innerHTML = "";
  if(!dev) {
    Android.limparLogs();
    Android.msg("Rodando...");
  }
  try {
    Android.arquivar("jogo.html", inicio);
    trocarPagina("jogo.html");
    document.getElementById("listaPaginas").value = "jogo.html";
  } catch(e) {
    const div = document.getElementById("console");
    if(div) {
      div.innerHTML += e.message + '\n';
      div.scrollTop = div.scrollHeight;
    }
  }
}

function atualizar() {
        if(dev) return;
        try {
            const arquivos = Android.listarArquivos(caminho);
            const divProjetos = document.getElementById("arquivos");
            const listaArquivos = JSON.parse(arquivos.replace("[", "[\"").replace("]", "\"]").replace(/, /g, "\",\""));
            divProjetos.innerHTML = "<p>Arquivos do projeto:</p><br><button onClick=\"voltarUmaPasta()\">voltar...</button><button onClick=\"ativarDeletar()\">Excluir</button><br>";
            listaArquivos.forEach(arquivo => {
              const dir = document.createElement("div");
              const pasta = document.createElement("div");
              pasta.id = "pasta";
              const texto = document.createElement("input");
              texto.value = arquivo;
              texto.style.cursor = "pointer";
              texto.style.margin = "10px";
              const img = document.createElement("img");
              img.src = "../.config/icones/txt.png";
              img.id = "icone";
              if(arquivo.endsWith(".png") || arquivo.endsWith(".jpg")) {
                  img.src = caminho+arquivo;
              } else if(arquivo.endsWith(".wav") || arquivo.endsWith(".mp3") || arquivo.endsWith(".ogg") || arquivo.endsWith(".m4a")) {
                  img.src = "../.config/icones/audio.png";
              } else if(Android.ehDir(caminho+arquivo)) img.src = "../.config/icones/pasta.png";
              pasta.appendChild(img);
              texto.addEventListener("click", (e) => {
                  e.stopPropagation();
              });
              texto.addEventListener("change", (e) => {
                  Android.renomear(arquivo, e.target.value);
                  atualizar();
              });
              pasta.onclick = () => {
                  if(Android.ehDir(arquivo)) caminho += arquivo + "/";
                  else {
                      document.getElementById("nomeArquivo").value = caminho+arquivo;
                      abrir();
                      trocarPagina("editor");
                      document.getElementById("listaPaginas").value = "editor";
                  }
                  atualizar();
              };
              pasta.appendChild(texto);
              dir.appendChild(pasta);
              if(modoDelete) {
                  const deletarBt = document.createElement("button");
                  deletarBt.textContent = "Excluir";
                  deletarBt.addEventListener("click", (e) => {
                      e.stopPropagation();
                  });
                  deletarBt.onclick = () => {
                      Android.deletar(caminho+arquivo);
                      atualizar();
                  };
                  pasta.appendChild(deletarBt);
              }
              divProjetos.appendChild(dir);
            });
        } catch(e) {
          document.getElementById("console").innerHTML += "Erro ao carregar projetos: " + e.message;
        }
      }
     
function voltarUmaPasta() {
    const pastas = caminho.split("/");
    caminho = "";
    for(let i = 0; i < pastas.length-1; i++) {
        if(pastas.length < 2) caminho = "";
    }
    document.getElementById("nomeArquivo").value = caminho;
    atualizar();
}
function voltarCasa() {
    Android.pacoteSub();
    window.location.href = "../inicio.html";
}
function ativarDeletar() {
    if(modoDelete) modoDelete = false;
    else modoDelete = true;
    atualizar();
}
function abrirScripts() {
    trocarPagina("scriptsMenu");
    document.getElementById("sairScripts").onclick = () => {
        document.getElementById("listaPaginas").value = "editor";
        trocarPagina("editor");
    };
    
    const cs = document.getElementById("componentes");
    cs.innerHTML = "";
    
    const add = document.createElement("button");
    add.textContent = "Adicionar script";
    add.onclick = () => {
        inicio += `<script>eval(Android.ler("scripts/novo.js"));<\/script>\n`;
        abrirScripts();
    };
    cs.appendChild(add);

    const regex = /Android\.ler\("([^"]+)"\)/g;
    let match;
    let scripts = Android.ler("jogo.html").split("\n");
    while((match = regex.exec(inicio)) !== null) {
        scripts.push({ caminho: match[1], index: match.index });
    }

    for(const script of scripts) {
        if(script.caminho == (null || undefined)) continue;
        const linha = document.createElement("div");

        const js = document.createElement("input");
        js.type = "text";
        js.value = script.caminho;
        
        if(!Android.arquivoExiste(script.caminho)) {
            Android.arquivar(script.caminho, "");
        }

        js.addEventListener("change", (e) => {
            inicio = inicio.replace(`<script>eval(Android.ler("${script.caminho}"));<\/script>\n`, `<script>eval(Android.ler("${e.target.value}"));<\/script>\n`);
        });

        const remover = document.createElement("button");
        remover.textContent = "Remover";
        remover.onclick = () => {
            inicio = inicio.replace(`<script>eval(Android.ler("${script.caminho}"));<\/script>\n`, "");
            abrirScripts();
        }
        linha.appendChild(js);
        linha.appendChild(remover);
        cs.appendChild(linha);
    }
}

document.getElementById("nomeArquivo").value = "scripts/jogo.js";
editor.setValue("const b = {\n  x: 0, y: 0,\n  escalaX: 60, escalaY: 60,\n  cor: \"blue\", click: () => console.log(\"teste\")\n};\neco.addBotao(b);", -1);
atualizar();
abrir();
</script>
  </body>
</html>
