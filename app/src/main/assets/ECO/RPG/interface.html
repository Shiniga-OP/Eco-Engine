<!DOCTYPE html>
<html>
  <head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Eco-Engine - central</title>
	<script src="engine.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.3/ace.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.3/ext-language_tools.min.js"></script>
<style>
html, body {
  margin:0;
  padding:0;
  height:100%;
  background:#111;
  color:#0f0;
  font-family:monospace;
  overflow:hidden;
}
#barraFerramentas, #pasta {
  border:1px solid #444;
  display:flex;
  padding:5px;
}
#barraFerramentas select, input, button {
  margin-right:5px;
  background:#111;
  border:1px solid #444;
  color:#0f0;
  padding:5px;
  cursor:pointer;
}
#pasta select, input, button {
  margin-right:5px;
  background:#111;
  border:1px solid #444;
  color:#0f0;
  padding:5px;
  cursor:pointer;
}
#barraFerramentas input { width:100px; }
#conteudo {
  height:calc(100% - 42px);
  position:relative;
  background:#000;
}
.pagina {
  display:none;
  position:absolute;
  top:0;
  left:0;
  width:100%;
  height:100%;
}

.pagina.ativa { display:block; }

#telaJogo {
  border: 1px solid #444;
  background: #000;
  display: block;
  margin: auto;
  position: absolute;
  top: 0; bottom: 0; left: 0; right: 0;
  image-rendering: pixelated;
  image-rendering: crisp-edges;
}

#editorCodigo {
  width:100%;
  height:100%;
}
#pagina {
  width:100%;
  height:100%;
  display:block;
}
#console {
    position:absolute;
    bottom:0;
    left:0;
    width:100%;
    height:100%;
    overflow:auto;
    background:#000;
    border-top:1px solid #444;
    color:#0f0;
    font-family:monospace;
    font-size:12px;
    white-space:pre-wrap;
}
</style>
  </head>
  <body>
	<div id="barraFerramentas">
	  <button onClick="location.reload()">Reiniciar</button>
	  <button onClick="voltarCasa()">Casa</button>
	  <select id="listaPaginas" onchange="trocarPagina(this.value)">
		<option value="jogo.html">Jogo</option>
		<option value="editor">Editor</option>
		<option value="arquivosDiv">Arquivos</option>
		<option value="console">Console</option>
		<option value="editorMapas.html">Editor de mapas</option>
		<option value="editorMusica.html">Produtor de músicas</option>
	  </select>
	  <button onclick="abrir()">Abrir</button>
	  <input id="nomeArquivo" type="text" placeholder="caminho do arquivo">
	  <button onclick="salvar()">Salvar</button>
	  <button onClick="executar()">Rodar</button>
	  <button onClick="abrirScripts()">HTML</button>
	  <button onclick="trocarPaginaB()"><</button>
	  <button onclick="trocarPaginaP()">></button>
	</div>
	<div id="conteudo">
	  <div id="editorMapas" class="pagina">
		<iframe id="pagina"></iframe>
	  </div>
	  <div id="jogo" class="pagina ativa">
		<canvas id="telaJogo"></canvas>
	  </div>
	  <div id="editor" class="pagina">
		<div id="editorCodigo"></div>
	  </div>
	  <div id="scriptsMenu" class="pagina">
	      <div>
	          <h3>Componentes do projeto:</h3><button id="sairScripts">X</button>
	      </div>
	      <div id="componentes"></div>
	  </div>
	  <div id="arquivosDiv" class="pagina">
		<div id="arquivos"></div>
	  </div>
	  <div id="console" class="pagina"></div>
	</div>
<script>
let caminho = "";
let dev = false;
let modoDelete = false;
let inicio = `<canvas id=\"telaJogo\"></canvas>\n<script>eval(\`\${Android.ler(\"nucleo.js\")}\nconst eco = new Motor(\"telaJogo\");\${Android.ler(\"jogo.js\")}\`);<\/script>\n`;
let scripts = "";
if(!dev) {
    if(Android.ler("jogo.html")=="") Android.arquivar("jogo.html", inicio+scripts);
}
const antigoConsoleLog = console.log;
console.log = function() {
    antigoConsoleLog.apply(console, arguments);
    const msg = Array.from(arguments).map(arg => {
        if(arg instanceof Error) return `Erro: ${arg.message}\nStack: ${arg.stack}`;
        else if(typeof arg === 'object' && arg !== null) {
            try {
                return JSON.stringify(arg, null, 2);
            } catch(e) {
                return String(arg);
            }
        } else return String(arg);
    });
    const div = document.getElementById("console");
    if(div) {
        div.innerHTML += msg.join(' ') + '\n';
        div.scrollTop = div.scrollHeight;
    }
};
const antigoConsoleError = console.error;
console.error = function() {
    antigoConsoleError.apply(console, arguments);
    const msg = Array.from(arguments).map(arg => {
        if(arg instanceof Error) return `❌ ERRO: ${arg.message}\nStack: ${arg.stack}`;
        else if(typeof arg === 'object' && arg !== null) {
            try {
                return `❌ ${JSON.stringify(arg, null, 2)}`;
            } catch(e) {
                return `❌ ${String(arg)}`;
            }
        } else return `❌ ${String(arg)}`;
    });
    const div = document.getElementById("console");
    if(div) {
        div.innerHTML += msg.join(' ') + '\n';
        div.scrollTop = div.scrollHeight;
    }
};
const antigoConsoleWarn = console.warn;
console.warn = function() {
    antigoConsoleWarn.apply(console, arguments);
    const msg = Array.from(arguments).map(arg => {
        if(typeof arg === 'object' && arg !== null) {
            try {
                return `⚠️ ${JSON.stringify(arg, null, 2)}`;
            } catch(e) {
                return `⚠️ ${String(arg)}`;
            }
        } else return `⚠️ ${String(arg)}`;
    });
    const div = document.getElementById("console");
    if(div) {
        div.innerHTML += msg.join(' ') + '\n';
        div.scrollTop = div.scrollHeight;
    }
};
const editor = ace.edit("editorCodigo");
editor.setTheme("ace/theme/monokai");
editor.session.setMode("ace/mode/javascript");
editor.setOptions({
    enableBasicAutocompletion: true,
    enableLiveAutocompletion: true, // completa enquanto digita
    showLineNumbers: true, // mostra numeração de linha
    showGutter: true, // mostra a gutter(area dos números)
    highlightActiveLine: true, // destaca a linha atual
});
console.log("console...");

function trocarPagina(id) {
  const paginas = document.querySelectorAll(".pagina");
  for(let i = 0; i < paginas.length; i++) paginas[i].classList.remove("ativa");

  if(id.includes("/") || id.endsWith(".html")) {
    document.getElementById("editorMapas").classList.add("ativa");
    document.getElementById("pagina").src = id;
  } else document.getElementById(id).classList.add("ativa");
}

function trocarPaginaB() {
  const lista = Array.from(document.getElementById("listaPaginas").options).map(opcao => opcao.value);
  const atual = document.getElementById("listaPaginas").value;
  let indice = lista.indexOf(atual);
  if(indice > 0) indice--;
  trocarPagina(lista[indice]);
  document.getElementById("listaPaginas").value = lista[indice];
}

function trocarPaginaP() {
  const lista = Array.from(document.getElementById("listaPaginas").options).map(opcao => opcao.value);
  const atual = document.getElementById("listaPaginas").value;
  let indice = lista.indexOf(atual);
  if(indice < lista.length - 1) indice++;
  trocarPagina(lista[indice]);
  document.getElementById("listaPaginas").value = lista[indice];
}

function salvar() {
  if(dev) return;
  const arq = document.getElementById("nomeArquivo").value.trim();
  Android.arquivar(arq, editor.getValue());
  Android.msg("Projeto salvo em: "+arq);
}

function abrir() {
  if(dev) return;
  const arq = document.getElementById("nomeArquivo").value.trim();
  if(arq.endsWith(".html")) editor.session.setMode("ace/mode/html");
  else if(arq.endsWith(".css")) editor.session.setMode("ace/mode/css");
  else if(arq.endsWith(".js")) editor.session.setMode("ace/mode/javascript");
  editor.setValue(Android.ler(arq), -1);
  Android.msg("Arquivo aberto");
}

function executar() {
  console.clear();
  document.getElementById("console").innerHTML = "";
  if(!dev) {
    Android.limparLogs();
    Android.msg("Rodando...");
  }
  try {
    Android.arquivar("jogo.html", inicio+scripts);
    trocarPagina("jogo.html");
    document.getElementById("listaPaginas").value = "jogo.html";
  } catch(e) {
    const div = document.getElementById("console");
    if(div) {
      div.innerHTML += e.message + '\n';
      div.scrollTop = div.scrollHeight;
    }
  }
}

function atualizar() {
        if(dev) return;
        try {
            const arquivos = Android.listarArquivos(caminho);
            const divProjetos = document.getElementById("arquivos");
            const listaArquivos = JSON.parse(arquivos.replace("[", "[\"").replace("]", "\"]").replace(/, /g, "\",\""));
            divProjetos.innerHTML = "<p>Arquivos do projeto:</p><br><button onClick=\"voltarUmaPasta()\">voltar...</button><button onClick=\"ativarDeletar()\">deletar</button><br>";
            listaArquivos.forEach(arquivo => {
              const dir = document.createElement("div");
              const pasta = document.createElement("div");
              pasta.id = "pasta";
              const texto = document.createElement("div");
              texto.textContent = arquivo;
              texto.style.cursor = "pointer";
              texto.style.margin = "10px";
              pasta.onclick = () => {
                  if(Android.ehDir(arquivo)) caminho += arquivo + "/";
                  else {
                      document.getElementById("nomeArquivo").value = caminho+arquivo;
                      abrir();
                      trocarPagina("editor");
                      document.getElementById("listaPaginas").value = "editor";
                  }
                  atualizar();
              };
              pasta.appendChild(texto);
              dir.appendChild(pasta);
              if(modoDelete) {
                  const deletarBt = document.createElement("button");
                  deletarBt.textContent = "Deletar";
                  deletarBt.onclick = () => {
                      Android.deletar(caminho+arquivo);
                      atualizar();
                  };
                  dir.appendChild(deletarBt);
              }
              divProjetos.appendChild(dir);
            });
        } catch(e) {
          document.getElementById("console").innerHTML += "Erro ao carregar projetos: " + e.message;
        }
      }
function voltarUmaPasta() {
    const pastas = caminho.split("/");
    caminho = "";
    for(let i = 0; i < pastas.length-1; i++) {
        if(pastas.length < 2) caminho = "";
    }
    document.getElementById("nomeArquivo").value = caminho;
    atualizar();
}
function voltarCasa() {
    Android.pacoteSub();
    window.location.href = "../inicio.html";
}
function ativarDeletar() {
    if(modoDelete) modoDelete = false;
    else modoDelete = true;
    atualizar();
}
function abrirScripts() {
    trocarPagina("scriptsMenu");
    document.getElementById("sairScripts").onclick = () => {
        document.getElementById("listaPaginas").value = "editor";
        trocarPagina("editor");
    }
    const cs = document.getElementById("componentes");
    cs.innerHTML = "";
    const comps = Android.ler("jogo.html").split("\n");
    for(let i = 0; i < comps.length; i++) {
        const item = document.createElement("div");
        item.textContent = comps[i]+"\n";
        cs.appendChild(item);
    }
}
document.getElementById("nomeArquivo").value = "jogo.js";
editor.setValue("const b = {\n  x: 0, y: 0,\n  escalaX: 60, escalaY: 60,\n  cor: \"blue\", click: () => console.log(\"teste\")\n};\neco.addBotao(b);", -1);
atualizar();
abrir();
</script>
  </body>
</html>
